<!DOCTYPE html>
<html>
  <head>
    <!-- Basic -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Mobile Metas -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- Site Metas -->
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="images/favicon.png" type="" />

    <!-- bootstrap core css -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />

    <!--owl slider stylesheet -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"
    />

    <!-- nice select  -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css"
      integrity="sha512-CruCP+TD3yXzlvvijET8wV5WxxEh5H8P4cmz0RFbKK6FlZ2sYl3AEsKlLPHbniXKSrDdFewhbmBK5skbdsASbQ=="
      crossorigin="anonymous"
    />

    <!-- font awesome style -->
    <link href="css/font-awesome.min.css" rel="stylesheet" />

    <!-- BOOTSTRAP -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    <!-- ICONS BOOTSTRAP -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
    />

    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet" />

    <!-- CSS -->
    <link rel="stylesheet" href="style.css" />

    <!-- responsive style -->
    <link href="css/responsive.css" rel="stylesheet" />

    <!-- ALPINE JS -->
    <script src="//unpkg.com/alpinejs" defer></script>

    <style>
      .alert {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
      }
      .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .d-none {
        display: none;
      }
      .spinner-border {
        width: 1rem;
        height: 1rem;
      }
    </style>

    <title>Login</title>
  </head>

  <body class="bg-login h-100dvh">
    <div class="d-flex bg-login h-100">
      <div
        class="kiri col-7 d-flex flex-column justify-content-center align-items-center text-light"
      >
        <div
          class="d-flex flex-column justify-content-center align-items-center"
        >
          <h2 class="m-1">Selamat datang kembali di</h2>
          <h2 class="fs-1">Dapur Kita</h2>
        </div>
        <p>Menjelajahi Rasa, Membagikan Kreativitas.</p>
        <div class="d-flex justify-content-center mb-3 mt-2">
          <a class="text-decoration-none" href="index.html"
            ><button type="submit" class="btn-manual">Kembali</button></a
          >
        </div>
      </div>
      <div
        class="kanan col-5 d-flex flex-column justify-content-center align-items-center text-light"
      >
        <div class="card bg-grey p-3 text-putih w-75">
          <h1 class="text-center mb-3">Selamat Datang</h1>
          <div id="message" class="alert d-none"></div>
          <form id="loginForm">
            <div class="mb-1">
              <label for="email" class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                id="email"
                name="email"
                required
              />
            </div>
            <div class="mb-2" x-data="{eye: true}">
              <label for="password" class="form-label">Password</label>
              <div
                class="d-flex justify-content-center align-items-center position-relative"
              >
                <input
                  :type="eye ? 'password' : 'text'"
                  class="form-control"
                  id="password"
                  name="password"
                  required
                  minlength="6"
                />
                <i
                  @click="eye = !eye"
                  :class="eye ? 'bi-eye-slash':'bi-eye-fill'"
                  class="bi text-hitam position-absolute cursor-pointer end-0 me-2"
                ></i>
              </div>
            </div>
            <div class="d-flex justify-content-end">
              <a href="#" class="cursor-pointer text-13px forget-hover"
                >Lupa password?</a
              >
            </div>
            <div class="d-flex justify-content-center my-3">
              <button type="submit" class="btn-manual">Masuk</button>
            </div>
          </form>

          <div
            class="d-flex flex-column justify-content-center align-items-center gap-2"
          >
            <p class="m-0 text-grey2 text-15px">atau masuk dengan</p>
            <div class="d-flex gap-2">
              <div class="icons">
                <img src="./icons/google.svg" alt="Google" />
              </div>
              <div class="icons">
                <img src="./icons/github.svg" alt="GitHub" />
              </div>
              <div class="icons">
                <img src="./icons/facebook.svg" alt="Facebook" />
              </div>
            </div>
            <p class="text-grey2 .text-15px">
              Belum punya akun?
              <span>
                <a
                  href="register.html"
                  class="cursor-pointer daftar-login_sekarang text-decoration-none"
                  >Daftar sekarang</a
                >
              </span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <script src="js/utils.js"></script>
<script>
  document
    .getElementById("loginForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const messageDiv = document.getElementById("message");
      messageDiv.classList.remove("d-none", "alert-success", "alert-danger");
      messageDiv.innerHTML =
        '<div class="spinner-border spinner-border-sm me-2"></div> Memproses login...';
      messageDiv.classList.remove("d-none");

      try {
        const response = await fetch(`${BASE_URL}/user/login`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include", // Important for cookies
          body: JSON.stringify({
            email: document.getElementById("email").value,
            password: document.getElementById("password").value,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || "Login failed");
        }

        // Success case
        messageDiv.classList.add("alert-success");
        messageDiv.innerHTML =
          '<i class="bi bi-check-circle me-2"></i> Login berhasil! Mengalihkan...';

        // Store access token in localStorage
        if (data.accessToken) {
          localStorage.setItem("auth._token", `Bearer ${data.accessToken}`);
        }

        // Store user data if available
        if (data.user) {
          localStorage.setItem("auth._user", JSON.stringify(data.user));
        }

        // Set refresh token in cookie if received
        if (data.refreshToken) {
          setRefreshTokenCookie(data.refreshToken);
        }

        // Redirect to dashboard after 1 second
        setTimeout(() => {
          window.location.href = "dashboard.html";
        }, 1000);
      } catch (error) {
        messageDiv.classList.add("alert-danger");
        messageDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i> ${
          error.message || "Terjadi kesalahan saat login"
        }`;
        console.error("Login error:", error);
      }
    });

  // Helper function to set refresh token cookie
  function setRefreshTokenCookie(token) {
    const expires = new Date();
    expires.setTime(expires.getTime() + 24 * 60 * 60 * 1000); // 1 day
    
    document.cookie = `refreshToken=${token}; expires=${expires.toUTCString()}; path=/; SameSite=Lax${
      location.protocol === 'https:' ? '; Secure' : ''
    }`;
  }

  // Check if coming from registration with token
  window.addEventListener("DOMContentLoaded", () => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("from_registration")) {
      const messageDiv = document.getElementById("message");
      messageDiv.classList.remove("d-none");
      messageDiv.classList.add("alert-success");
      messageDiv.textContent = "Registrasi berhasil! Silakan login.";
    }
  });
</script>
  </body>
</html>
