<!DOCTYPE html>
<html>
  <head>
    <!-- Basic -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Mobile Metas -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- Site Metas -->
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="images/favicon.png" type="" />

    <!-- bootstrap core css -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />

    <!--owl slider stylesheet -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"
    />

    <!-- nice select  -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css"
      integrity="sha512-CruCP+TD3yXzlvvijET8wV5WxxEh5H8P4cmz0RFbKK6FlZ2sYl3AEsKlLPHbniXKSrDdFewhbmBK5skbdsASbQ=="
      crossorigin="anonymous"
    />

    <!-- font awesome style -->
    <link href="css/font-awesome.min.css" rel="stylesheet" />

    <!-- BOOTSTRAP -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    <!-- ICONS BOOTSTRAP -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
    />

    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet" />

    <!-- CSS -->
    <link rel="stylesheet" href="style.css" />

    <!-- responsive style -->
    <link href="css/responsive.css" rel="stylesheet" />

    <!-- ALPINE JS -->
    <script src="//unpkg.com/alpinejs" defer></script>

    <!-- TINYMCE ~~ Textarea Editor -->
    <!-- TinyMCE CDN -->
    <script
      src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js"
      referrerpolicy="origin"
    ></script>

    <script>
      tinymce.init({
        selector: "textarea#editor",
      });
    </script>
    <title>Detail</title>
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar bg-grey py-2 px-5 shadow-lg d-flex align-items-center">
      <h1 class="my-2 text-putih fs-2">Dapur Kita</h1>
      <div class="d-flex gap-4">
        <a class="text-decoration-none text-light nav-item" href="index.html"
          >Home</a
        >
        <a class="text-decoration-none text-light nav-item" href="menu.html"
          >Resep</a
        >
        <a class="text-decoration-none text-light nav-item" href="about.html"
          >Tentang Kami</a
        >
      </div>
      <div class="d-flex justify-content-center align-items-center gap-3">
        <i class="bi bi-search fs-5 text-putih"></i>
        <a href="dashboard.html">
          <img
            src="img/profile/65683b5ca0a91.jpeg"
            alt=""
            class="profilePicture"
          />
        </a>
      </div>
    </nav>
    <!-- END NAVBAR -->

    <!-- Main Section -->
    <section class="container d-flex flex-column gap-4 pt-4 pb-5">
      <img src="" alt="Foto Resep" class="gambar-resep rounded-4 shadow-lg" />
      <div class="kotak shadow">
        <h2 class="fs-1"></h2>
        <p class="m-0"></p>
        <p class="m-0 pt-2"></p>
      </div>
      <!-- Bahan-bahan -->
  <div class="kotak shadow d-flex flex-column gap-1">
    <h2 class="fs-3">Bahan-bahan</h2>
    <div class="garis"></div>
    <div id="ingredients-container" class="p-3"></div>
  </div>
  
  <!-- Cara Pembuatan -->
  <div class="kotak shadow d-flex flex-column gap-1">
    <h2 class="fs-3">Cara Pembuatan</h2>
    <div class="garis"></div>
    <div id="instructions-container" class="p-3"></div>
  </div>
      </div>
      <div class="kotak shadow">
        <h2 class="fs-3">Ditulis Oleh</h2>
        <div class="garis"></div>
        <div class="d-flex gap-3 justify-content-start align-items-center mb-2">
          <img
            src="img/profile/profile-dummy.png"
            alt=""
            class="profileDitulis"
          />
          <div>
            <h6 class="fs-5 mb-0"></h6>
            <p class="m-0"></p>
          </div>
        </div>
        <p class="my-0"></p>
      </div>
      <div class="kotak shadow">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="fs-3">Resep lain dari penulis</h2>
          <i class="bi bi-arrow-right fs-3 fw-bold cursor-pointer"></i>
        </div>
        <div class="garis"></div>
        <div class="d-flex flex-wrap gap-3">
          <!-- Resep lain akan dimasukkan secara dinamis -->
        </div>
      </div>

      <!-- Komentar Section -->
      <div class="kotak shadow d-flex flex-column gap-1">
        <h2 class="fs-3">Tinggalkan Komentar</h2>
        <div class="garis"></div>
        <form id="commentForm" class="d-flex flex-column gap-2">
          <textarea
            class="form-control"
            id="komentar"
            rows="3"
            placeholder="Tulis komentar..."
            required
          ></textarea>
          <button type="submit" class="btn btn-primary w-25">Kirim</button>
        </form>
      </div>

      <div class="kotak shadow d-flex flex-column gap-1">
        <h2 class="fs-3">Komentar Pengunjung</h2>
        <!-- Komentar akan dimasukkan secara dinamis -->
      </div>
    </section>

    <!-- footer section -->
    <footer class="footer_section">
      <div class="container">
        <div class="row">
          <div class="col-md-4 footer-col">
            <div class="footer_contact">
              <h4>Hubungi Kami</h4>
              <div class="contact_link_box">
                <a href="">
                  <i class="fa fa-phone" aria-hidden="true"></i>
                  <span> WA 08123456789 </span>
                </a>
                <a href="">
                  <i class="fa fa-envelope" aria-hidden="true"></i>
                  <span> dapurkita@gmail.com </span>
                </a>
              </div>
            </div>
          </div>
          <div class="col-md-4 footer-col">
            <div class="footer_detail">
              <a href="" class="footer-logo"> Dapur Kita </a>
              <p style="text-align: justify">
                Dapur Kita, sumber inspirasi kuliner penuh kreativitas! Temukan
                resep-resep lezat dari berbagai masakan, ikuti tips ahli, dan
                jalin komunitas dengan sesama pecinta masak.
              </p>
              <br />
              <div class="footer_social">
                <a href="">
                  <i class="fa fa-facebook" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-twitter" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-linkedin" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-instagram" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-pinterest" aria-hidden="true"></i>
                </a>
              </div>
            </div>
          </div>
          <div class="col-md-4 footer-col">
            <h4>Apa yang pembuat katakan</h4>
            <p>Selamat memasak!</p>
            <p>SEMANGAT!</p>
          </div>
        </div>
        <div class="footer-info">
          <p>
            &copy; <span id="displayYear"></span> Dibuat oleh
            <a href="https://themewagon.com/" target="_blank">Dapur Kita</a>
          </p>
        </div>
      </div>
    </footer>
    <!-- footer section -->

    <!-- jQery -->
    <script src="js/jquery-3.4.1.min.js"></script>
    <!-- popper js -->
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <!-- bootstrap js -->
    <script src="js/bootstrap.js"></script>
    <!-- owl slider -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <!-- isotope js -->
    <script src="https://unpkg.com/isotope-layout@3.0.4/dist/isotope.pkgd.min.js"></script>
    <!-- nice select -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js"></script>
    <!-- custom js -->
    <script src="js/custom.js"></script>
    <!-- Google Map -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCh39n5U-4IoWpsVGUHWdqB6puEkhRLdmI&callback=myMap"></script>
    <!-- End Google Map -->

    <script src="js/utils.js"></script>
    <!-- Script untuk menampilkan detail resep -->
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        // Fungsi untuk memeriksa status login dan menyesuaikan navbar
        function checkLoginStatus() {
          const token = localStorage.getItem("auth._token");
          const userData =
            JSON.parse(localStorage.getItem("auth._user")) || null;

          const navbar = document.querySelector(
            ".navbar .d-flex.justify-content-center.align-items-center.gap-3"
          );

          if (token && userData) {
            // Jika sudah login - tampilkan foto profil
            navbar.innerHTML = `
                <i class="bi bi-search fs-5 text-putih"></i>
                <a href="dashboard.html">
                    <img src="${
                      userData.profilePicture || "img/profile/profile-dummy.png"
                    }" 
                         alt="Profile" 
                         class="profilePicture rounded-circle"
                         style="width: 40px; height: 40px; object-fit: cover;">
                </a>
            `;
          } else {
            // Jika belum login - tampilkan tombol login
            navbar.innerHTML = `
                <div class="user_option">
                <a href="login.html" class="order_online"> Login </a>
              </div>
            `;
          }
        }

        // Panggil fungsi untuk memeriksa status login
        checkLoginStatus();

        // Fungsi untuk menangani komentar berdasarkan status login
        function handleCommentForm() {
          const commentForm = document.getElementById("commentForm");
          const token = localStorage.getItem("auth._token");

          if (!token) {
            // Jika belum login, ubah form komentar
            commentForm.innerHTML = `
                <div class="alert alert-info">
                    Anda harus login untuk memberikan komentar
                </div>
                <a href="login.html" class="btn btn-primary w-25">Login</a>
            `;
          }
        }

        // Panggil fungsi untuk menangani form komentar
        handleCommentForm();

        // Ambil ID resep dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get("id");

        if (!recipeId) {
          alert("Resep tidak ditemukan");
          window.location.href = "index.html";
          return;
        }

        try {
          // Ambil data resep dari API
          const response = await fetch(`${BASE_URL}/recipes/${recipeId}`);
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "Gagal memuat resep");
          }

          const recipe = data.data;

          // Tampilkan data resep ke halaman
          displayRecipeDetails(recipe);

          // Ambil resep lain dari penulis yang sama
          await fetchUserRecipes(recipe.userId, recipeId);

          // Setup form komentar
          setupCommentForm(recipeId);

          // Ambil komentar untuk resep ini
          await fetchComments(recipeId);
        } catch (error) {
          console.error("Error:", error);
          alert(error.message);
          window.location.href = "index.html";
        }
      });

      // Fungsi untuk menampilkan detail resep
      function displayRecipeDetails(recipe) {
        // Gambar resep
        const recipeImage = document.querySelector(".gambar-resep");
        if (recipe.imageUrl) {
          recipeImage.src = recipe.imageUrl;
        } else {
          recipeImage.src = "img/resep/default-recipe.jpg"; // Gambar default jika tidak ada
        }

        // Judul resep
        document.querySelector(".kotak.shadow h2.fs-1").textContent =
          recipe.title;

        // Penulis resep
        document.querySelector(".kotak.shadow p.m-0").textContent = `By. ${
          recipe.User ? recipe.User.username : "Penulis tidak diketahui"
        }`;

        // Deskripsi resep
        document.querySelector(".kotak.shadow p.m-0.pt-2").textContent =
          recipe.description;

        // Bahan-bahan
        const ingredientsContainer = document.getElementById(
          "ingredients-container"
        );
        if (recipe.ingredients) {
          // Jika ingredients adalah HTML (dari Quill editor)
          if (recipe.ingredients.includes("<")) {
            ingredientsContainer.innerHTML = recipe.ingredients;
          } else {
            // Jika plain text, konversi ke HTML
            ingredientsContainer.innerHTML = recipe.ingredients
              .split("\n")
              .map((ing) => `<p>${ing}</p>`)
              .join("");
          }
        } else {
          ingredientsContainer.innerHTML =
            "<p>Tidak ada bahan yang tercantum</p>";
        }

        // Cara pembuatan - PERBAIKAN
        const instructionsContainer = document.getElementById(
          "instructions-container"
        );
        if (recipe.instructions) {
          // Jika instructions adalah HTML (dari Quill editor)
          if (recipe.instructions.includes("<")) {
            instructionsContainer.innerHTML = recipe.instructions;
          } else {
            // Jika plain text, konversi ke HTML dengan nomor langkah
            instructionsContainer.innerHTML = recipe.instructions
              .split("\n")
              .filter((step) => step.trim() !== "")
              .map(
                (step, i) => `<p><strong>Langkah ${i + 1}:</strong> ${step}</p>`
              )
              .join("");
          }
        } else {
          instructionsContainer.innerHTML =
            "<p>Tidak ada cara pembuatan yang tercantum</p>";
        }

        // Info penulis
        const authorInfo = document.querySelector(
          ".kotak.shadow .d-flex.gap-3.justify-content-start.align-items-center"
        );
        if (recipe.User && recipe.User.profilePicture) {
          authorInfo.querySelector("img").src = recipe.User.profilePicture;
        }
        authorInfo.querySelector("h6").textContent = recipe.User
          ? recipe.User.username
          : "Penulis tidak diketahui";
        authorInfo.querySelector("p").textContent = `pada tanggal ${new Date(
          recipe.createdAt
        ).toLocaleDateString()}`;

        // Headline penulis (jika ada)
        const authorHeadline = document.querySelector(".kotak.shadow p.my-0");
        if (recipe.User && recipe.User.headline) {
          authorHeadline.textContent = recipe.User.headline;
        } else {
          authorHeadline.textContent = "Pecinta masak dan penikmat kuliner";
        }
      }

      // Fungsi untuk mengambil resep lain dari penulis yang sama
      async function fetchUserRecipes(userId, currentRecipeId) {
        try {
          const response = await fetch(`${BASE_URL}/recipes/user/${userId}`);
          const data = await response.json();

          if (response.ok && data.data && data.data.length > 0) {
            displayUserRecipes(
              data.data.filter((recipe) => recipe.id !== currentRecipeId)
            );
          }
        } catch (error) {
          console.error("Gagal mengambil resep pengguna:", error);
        }
      }

      // Fungsi untuk menampilkan resep lain dari penulis
      function displayUserRecipes(recipes) {
        const otherRecipesContainer = document.querySelector(
          ".d-flex.flex-wrap.gap-3"
        );
        otherRecipesContainer.innerHTML = "";

        // Batasi hanya 3 resep yang ditampilkan
        const recipesToShow = recipes.slice(0, 3);

        recipesToShow.forEach((recipe) => {
          const recipeCard = document.createElement("a");
          recipeCard.href = `detail.html?id=${recipe.id}`;
          recipeCard.innerHTML = `
                  <div class="bg-grey border-radius-15px">
                      <img src="${
                        recipe.imageUrl || "img/resep/default-recipe.jpg"
                      }" alt="" class="gambar-card">
                      <p class="my-1 py-1 text-wrap text-center text-putih">${
                        recipe.title
                      }</p>
                  </div>
              `;
          otherRecipesContainer.appendChild(recipeCard);
        });

        // Jika tidak ada resep lain
        if (recipesToShow.length === 0) {
          otherRecipesContainer.innerHTML =
            "<p>Belum ada resep lainnya dari penulis ini.</p>";
        }
      }

      // Fungsi untuk setup form komentar - Diperbaiki
      function setupCommentForm(recipeId) {
        const commentForm = document.getElementById("commentForm");
        const commentTextarea = document.getElementById("komentar");

        commentForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          const content = commentTextarea.value.trim();

          if (!content) {
            alert("Komentar tidak boleh kosong");
            return;
          }

          try {
            const token = localStorage.getItem("auth._token");
            if (!token) {
              alert("Anda harus login untuk memberikan komentar");
              window.location.href = "login.html";
              return;
            }

            // Kirim komentar ke server
            const response = await fetch(
              `${BASE_URL}/comments/new/${recipeId}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: token,
                },
                body: JSON.stringify({ content }),
              }
            );

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.message || "Gagal mengirim komentar");
            }

            // Reset form dan refresh komentar
            commentForm.reset();
            await fetchComments(recipeId);

            // Scroll ke bagian komentar
            document
              .querySelector(
                ".kotak.shadow.d-flex.flex-column.gap-1:last-child"
              )
              .scrollIntoView({
                behavior: "smooth",
              });
          } catch (error) {
            console.error("Error:", error);
            alert(`Gagal mengirim komentar: ${error.message}`);
          }
        });
      }

      // Fungsi untuk mengambil komentar - Diperbaiki
      async function fetchComments(recipeId) {
        try {
          const response = await fetch(
            `${BASE_URL}/comments/recipe/${recipeId}`
          );
          const data = await response.json();

          const commentsContainer = document.querySelector(
            ".kotak.shadow.d-flex.flex-column.gap-1:last-child"
          );
          commentsContainer.innerHTML =
            '<h2 class="fs-3">Komentar Pengunjung</h2><div class="garis"></div>';

          if (!response.ok || !data.data || data.data.length === 0) {
            const noCommentsMsg = document.createElement("div");
            noCommentsMsg.className = "alert alert-info mt-3";
            noCommentsMsg.textContent =
              "Belum ada komentar untuk resep ini. Jadilah yang pertama berkomentar!";
            commentsContainer.appendChild(noCommentsMsg);
            return;
          }

          // Buat wrapper untuk komentar
          const commentsWrapper = document.createElement("div");
          commentsWrapper.className = "mt-3";

          data.data.forEach((comment) => {
            const commentElement = document.createElement("div");
            commentElement.className =
              "d-flex gap-3 align-items-start p-3 border rounded mb-3 bg-white";

            // Format tanggal
            const commentDate = new Date(comment.createdAt);
            const formattedDate = commentDate.toLocaleDateString("id-ID", {
              day: "numeric",
              month: "long",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });

            commentElement.innerHTML = `
            <img src="${
              comment.User.profilePicture || "img/profile/profile-dummy.png"
            }"
                 alt="Foto Profil" 
                 class="rounded-circle" 
                 style="width: 50px; height: 50px; object-fit: cover;">
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <h6 class="mb-0 fw-bold">${comment.User.username}</h6>
                <small class="text-muted">${formattedDate}</small>
              </div>
              <p class="mb-0">${comment.content}</p>
              ${
                comment.userId ===
                JSON.parse(localStorage.getItem("auth._user"))?.id
                  ? `
                <div class="mt-2">
                  <button class="btn btn-sm btn-outline-secondary edit-comment" data-id="${comment.id}">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-comment ms-2" data-id="${comment.id}">
                    <i class="bi bi-trash"></i> Hapus
                  </button>
                </div>
              `
                  : ""
              }
            </div>
          `;

            commentsWrapper.appendChild(commentElement);
          });

          commentsContainer.appendChild(commentsWrapper);

          // Tambahkan event listener untuk tombol edit dan hapus
          setupCommentActions(recipeId);
        } catch (error) {
          console.error("Gagal mengambil komentar:", error);
          const commentsContainer = document.querySelector(
            ".kotak.shadow.d-flex.flex-column.gap-1:last-child"
          );
          commentsContainer.innerHTML += `
          <div class="alert alert-danger mt-3">
            Gagal memuat komentar: ${error.message}
          </div>
        `;
        }
      }

      // Fungsi untuk menangani aksi edit/hapus komentar
      function setupCommentActions(recipeId) {
        // Edit komentar
        document.querySelectorAll(".edit-comment").forEach((button) => {
          button.addEventListener("click", async function () {
            const commentId = this.getAttribute("data-id");
            const commentContent =
              this.closest(".flex-grow-1").querySelector("p").textContent;

            // Ganti dengan textarea untuk edit
            const editForm = document.createElement("div");
            editForm.innerHTML = `
            <textarea class="form-control mb-2">${commentContent}</textarea>
            <div>
              <button class="btn btn-sm btn-primary save-edit">Simpan</button>
              <button class="btn btn-sm btn-outline-secondary cancel-edit ms-2">Batal</button>
            </div>
          `;

            const commentElement = this.closest(
              ".d-flex.gap-3.align-items-start"
            );
            commentElement.querySelector(".flex-grow-1").innerHTML =
              editForm.innerHTML;

            // Setup event listener untuk simpan dan batal
            commentElement
              .querySelector(".save-edit")
              .addEventListener("click", async () => {
                const newContent = commentElement
                  .querySelector("textarea")
                  .value.trim();
                if (!newContent) {
                  alert("Komentar tidak boleh kosong");
                  return;
                }

                try {
                  const token = localStorage.getItem("auth._token");
                  const response = await fetch(
                    `${BASE_URL}/comments/edit/${commentId}`,
                    {
                      method: "PUT",
                      headers: {
                        "Content-Type": "application/json",
                        Authorization: token,
                      },
                      body: JSON.stringify({ content: newContent }),
                    }
                  );

                  const data = await response.json();

                  if (!response.ok) {
                    throw new Error(
                      data.message || "Gagal mengupdate komentar"
                    );
                  }

                  await fetchComments(recipeId);
                } catch (error) {
                  console.error("Error:", error);
                  alert(`Gagal mengupdate komentar: ${error.message}`);
                }
              });

            commentElement
              .querySelector(".cancel-edit")
              .addEventListener("click", () => {
                fetchComments(recipeId);
              });
          });
        });

        // Hapus komentar
        document.querySelectorAll(".delete-comment").forEach((button) => {
          button.addEventListener("click", async function () {
            const commentId = this.getAttribute("data-id");
            if (!confirm("Apakah Anda yakin ingin menghapus komentar ini?")) {
              return;
            }

            try {
              const token = localStorage.getItem("auth._token");
              const response = await fetch(
                `${BASE_URL}/comments/delete/${commentId}`,
                {
                  method: "DELETE",
                  headers: {
                    Authorization: token,
                  },
                }
              );

              const data = await response.json();

              if (!response.ok) {
                throw new Error(data.message || "Gagal menghapus komentar");
              }

              await fetchComments(recipeId);
            } catch (error) {
              console.error("Error:", error);
              alert(`Gagal menghapus komentar: ${error.message}`);
            }
          });
        });
      }
    </script>
  </body>
</html>
